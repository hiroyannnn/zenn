---
title: "MoonBit ã‚’ä½¿ã£ã¦backendå®Ÿè£…ã‚’ã—ã¦ã¿ã‚‹"
emoji: "ğŸ¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["MoonBit", "backend", "ddd", "nodejs"]
published: false
---

ã“ã®è¨˜äº‹ã¯ [Moonbit Advent Calendar 2025](https://qiita.com/advent-calendar/2025/moonbit) ã®15æ—¥ç›®ã§ã™ã€‚

## ã¯ã˜ã‚ã«

è‡ªåˆ†ã¯æ™®æ®µã€**Hono + TypeScript** ã§ Web ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’æ›¸ã„ã¦ã„ã¾ã™ã€‚
ãã‚“ãªä¸­ã§ MoonBit ã¨ã„ã†è¨€èªã‚’çŸ¥ã‚Šã€ã€Œã“ã‚Œã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ã‚‚ä½¿ãˆãªã„ã‹ãªï¼Ÿã€
ã¨æ°—ã«ãªã£ãŸã®ãŒã€ã“ã®è¨˜äº‹ã‚’æ›¸ãå§‹ã‚ãŸãã£ã‹ã‘ã§ã—ãŸã€‚

ç§è‡ªèº«ã¯ MoonBit ã«è©³ã—ã„ã‚ã‘ã§ã‚‚æŠ€è¡“çš„ã«æ–°ã—ã„ã“ã¨ã‚’ã‚„ã£ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„ã®ã§
èª¿æŸ»ä¸è¶³ã‚„é–“é•ã£ã¦ã„ã‚‹ã“ã¨ã‚‚å¤šã€…ã‚ã‚‹ã¨æ€ã„ã¾ã™ãŒã€ãƒ¡ãƒ¢ã‚’èª­ã‚€ãã‚‰ã„ã®ãƒ©ãƒ•ãªæ°—æŒã¡ã§èª­ã‚“ã§ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

---

## MoonBit ã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ä½¿ã†ã¨ãã®å‰æï¼ˆè‡ªåˆ†ã®ç†è§£ï¼‰

- MoonBit ã¯ WebAssembly/JavaScript ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã§ãã‚‹
- é€†ã«ã€ã„ã‚ã‚†ã‚‹ã€ŒWebãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€ãŒæƒã£ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„

ãªã®ã§ä»Šå›ã¯ã€

- HTTP ã‚µãƒ¼ãƒãƒ¼
- DB æ¥ç¶š
- èªè¨¼
- ã‚­ãƒ¥ãƒ¼å‡¦ç†
- ãƒ­ã‚°ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹

ãªã©ã®åŸºæœ¬çš„ãªæ©Ÿèƒ½ã¯tså´ã§æ›¸ãã“ã¨ã‚’å‰æã¨ã—ã¦ã€
entity ãªã©ã® å°ã•ã„ç¯„å›²ã§MoonBit ã‚’æ´»ç”¨ã™ã‚‹æ–¹å‘ã§è©¦ã—ã¾ã—ãŸã€‚

---

## ä»Šå›ä½œã£ãŸãƒªãƒã‚¸ãƒˆãƒª

- [moonbit-domain](https://github.com/hiroyannnn/moonbit-domain)

æœ€åˆã€ä½•ã‚‚è€ƒãˆãšãƒªãƒã‚¸ãƒˆãƒªåã‚’ `moonbit-domain` ã«ã—ãŸã®ã§ã™ãŒã€
MoonBit ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼ˆ`moon.mod.json` ã® `name`ï¼‰ã¯ **è‹±æ•°å­— + `_` ã ã‘**ï¼ˆãƒã‚¤ãƒ•ãƒ³ä¸å¯ï¼‰ã¨ã„ã†åˆ¶ç´„ãŒã‚ã‚Šã€
`moon new` ã‚’é›‘ã«å©ãã¨ã“ã“ã§ã‚³ã‚±ã¾ã—ãŸã€‚

ãƒ•ã‚©ãƒ«ãƒ€åã¯ãã®ã¾ã¾ã§ã€MoonBit ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’æŒ‡å®šã™ã‚‹å½¢ã§ newã—ã¾ã—ãŸã€‚

```sh
cd backend/domain/moonbit
moon new . --name moonbit_domain
```

---

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰

ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯é›‘ã«ä½œã£ã¦ã„ã‚‹ã®ã§ã€ã“ã‚ŒãŒæœ€é©ã§ã¯ãªã„ã¨æ€ã„ã¾ã™ãŒ

- ts ã¯ `backend/src` é…ä¸‹
- MoonBit ã¯ `backend/domain/moonbit/` ã«ç½®ã
- ç”Ÿæˆç‰©ã¯ `target/js/{debug|release}/build/...` ã«å›ºå®šã§å‡ºã‚‹ï¼ˆå‡ºåŠ›å…ˆã¯æŒ‡å®šã§ããªã„ï¼‰

```text
moonbit-domain/
â””â”€ backend/
   â”œâ”€ src/
   â”‚  â”œâ”€ app.ts
   â”‚  â””â”€ routes/
   â””â”€ domain/
      â””â”€ moonbit/
         â”œâ”€ moon.mod.json
         â”œâ”€ src/
         â”‚  â””â”€ domain/
         â”‚     â”œâ”€ moon.pkg.json
         â”‚     â”œâ”€ email.mbt
         â”‚     â””â”€ user_entity.mbt
         â””â”€ target/   # è‡ªå‹•ç”Ÿæˆï¼ˆã‚³ãƒŸãƒƒãƒˆã—ãªã„ï¼‰
```

ã¨ã„ã†å‰æã§é€²ã‚ã¾ã—ãŸã€‚

---

## MoonBit å´ã®ã‚³ãƒ¼ãƒ‰ä¾‹ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰

```moonbit
///|
pub struct Email {
  value : String
}

///|
pub fn Email::new(raw : String) -> Result[Email, String] {
  if raw.contains("@") {
    Ok({ value: raw })
  } else {
    Err("invalid email")
  }
}

///|
pub fn email_new(raw : String) -> Result[Email, String] {
  Email::new(raw)
}
```

---

## Node.js å´ã‹ã‚‰ä½¿ã†

MoonBit ã‚’ JS ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã§ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã¨ã€
å›ºå®šã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆ`target/js/release/build/...`ï¼‰ã« JS ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

```ts
import { email_new } from '../../domain/moonbit/target/js/release/build/src/domain/domain.js'

const r = email_new(input)

// Result ã¯ { $tag: 1, _0: value } / { $tag: 0, _0: error } ã®å½¢
if (r.$tag === 0) {
  throw new Error(r._0)
}

const email = r._0
console.log(email.value)
```

â€» Result ã®è¡¨ç¾ã¯ç”Ÿæˆ JS ä¸Šã§ã¯ `$tag` ã¨ `_0` ã«ãªã£ã¦ã„ã¦ã€
ã“ã®æ®µéšï¼ˆJS ãƒ™ãƒ¼ã‚¹ã®æœ€å°æ§‹æˆï¼‰ã§ã¯ä¸€æ—¦ãã®ã¾ã¾æ‰±ã£ã¦ã„ã¾ã™ã€‚
å¾Œè¿°ã®ãƒ–ãƒªãƒƒã‚¸ç”Ÿæˆãƒ„ãƒ¼ãƒ«ï¼ˆ`moonbit_ts_bridge`ï¼‰ã§ã¯ã€TS å´ã¯ `{ ok; value/error }` ã®å½¢ã§æ‰±ãˆã‚‹ã‚ˆã†ã«å¯„ã›ã¾ã™ã€‚

### curl ã§å‹•ä½œç¢ºèªï¼ˆHonoï¼‰

ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ã‹ã‚‰ï¼ˆä¾‹ï¼š`pnpm -C backend dev`ï¼‰ã€
`/validate/email` ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã¨ã€MoonBit å´ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒåŠ¹ã„ã¦ã„ã‚‹ã®ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

```sh
curl -i -X POST http://localhost:3000/validate/email \
  -H 'Content-Type: application/json' \
  -d '{"email":"a@b.com"}'

{"ok":true,"email":"a@b.com"}

curl -i -X POST http://localhost:3000/validate/email \
  -H 'Content-Type: application/json' \
  -d '{"email":"ab"}'

{"ok":false,"error":"`email` must be a string"}
```

---

## TypeScript ã§å‹ä»˜ãã§æ‰±ã†ãŸã‚ã®ãƒ„ãƒ¼ãƒ«

é€”ä¸­ã¾ã§ã¯ JS ãƒ™ãƒ¼ã‚¹ã§è©¦ã—ã¦ã„ãŸã®ã§ã™ãŒã€TS å´ã§å‹ãŒä»˜ã„ã¦ã„ãŸã»ã†ãŒä¾¿åˆ©ã ãªâ€¦ã¨ãªã‚Šã€
ï¼ˆMoonBit ã¯ JS ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå‘ã‘ã«å…¬å¼ã§ `.d.ts` ã‚‚ç”Ÿæˆã—ã¦ãã‚Œã¾ã™ãŒã€`any` ãŒæ··ã–ã£ãŸã‚Šã—ã¦ã€TS å´ã®ä½“é¨“ãŒã¾ã è’ã„å°è±¡ãŒã‚ã‚Šã¾ã—ãŸï¼‰
MoonBit ã® `pkg.generated.mbti`ï¼ˆ`moon info` ã§ç”Ÿæˆï¼‰ã¨ `moon.pkg.json` ã® `link.js.exports` ã‚’å…ƒã«ã€TypeScript ã®è–„ã„ãƒ–ãƒªãƒƒã‚¸ï¼ˆå‹å®šç¾©ï¼‹exportï¼‰ã‚’ç”Ÿæˆã™ã‚‹å°ã•ã„ãƒ„ãƒ¼ãƒ«ã‚’ä½œã‚Šã¾ã—ãŸã€‚

- <https://www.npmjs.com/package/@hiroyannnn/moonbit-ts-bridge>

ä½¿ã„æ–¹ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼š

```sh
# MoonBit å´ã§ `moon info` / `moon build` æ¸ˆã¿ã®å‰æ
npx @hiroyannnn/moonbit-ts-bridge --module backend/domain/moonbit --out backend/src/domain/moonbit_domain.ts
```

### TS å´ã®æ›¸ãå‘³ï¼ˆä½•ãŒå¬‰ã—ããªã£ãŸã‹ï¼‰

ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã†ã¨ã€TS å´ã§ã¯ä»¥ä¸‹ã®ç‚¹ãŒæ›¸ãã‚„ã™ããªã‚Šã¾ã—ãŸã€‚

- `Result` ã‚’ `{ ok: true; value } | { ok: false; error }` ã®å½¢ã§æ‰±ãˆã‚‹
  - MoonBit ã® `$tag` / `_0` ã‚’ç›´æ¥è§¦ã‚‰ãªãã¦ã‚ˆããªã‚‹
- `pub struct` ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒ TS ã®å‹ã¨ã—ã¦å‡ºã‚‹
  - `User` ãŒ `{ name: string; email: Email }` ã®ã‚ˆã†ã«è¦‹ãˆã‚‹ï¼ˆå€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ä¿æŒã§ãã‚‹ï¼‰

ä¾‹ãˆã° Hono ã® route ã§ã¯ã€ã“ã‚“ãªæ„Ÿã˜ã§ã€Œæ™®é€šã® TSã€ã£ã½ãæ›¸ã‘ã¾ã™ï¼š

```ts
import {
  emailNew,
  userNew,
} from './domain/moonbit_domain'

const r = userNew(name, email)
if (!r.ok) return c.json({ ok: false, error: r.error }, 422)

const user = r.value
return c.json(
  { ok: true, user: { name: user.name, email: user.email.value } },
  200
)
```

MoonBit å´ã®å…¬å¼ç”Ÿæˆç‰©ï¼ˆ`.d.ts` ãªã©ï¼‰ãŒã‚‚ã£ã¨ãƒªãƒƒãƒã«ãªã£ã¦ã„ã‘ã°ã€ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ä¸è¦ã«ãªã‚‹ã‹ã€ã‹ãªã‚Šè–„ã„å±¤ã«ç¸®é€€ã™ã‚‹ã¨æ€ã„ã¾ã™ã€‚

---

## çµ‚ã‚ã‚Šã«

å®Œå…¨ã«å€‹äººçš„ãªæ„è¦‹ã§ã™ãŒã€ã“ã®ä½¿ã„æ–¹ã§ã‚ã‚Œã°ç¾æ™‚ç‚¹ã§ã‚‚ååˆ†ä½¿ãˆã‚‹ãªãã¨æ€ã„ã¾ã—ãŸã€‚
